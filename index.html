<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TaskMaster Pro - User & Admin Portal</title>
    <style>
        :root {
            /* Spotify-like Palette for Admin */
            --spotify-black: #121212;
            --spotify-dark-grey: #181818;
            --spotify-light-grey: #282828;
            --spotify-white: #ffffff;
            --spotify-green: #1db954;
            --spotify-green-hover: #1ed760;
            --spotify-text-grey: #b3b3b3;
            --error: #e91429;
            
            /* User Palette */
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
        }

        /* --- SMOOTH SCROLL SETTINGS --- */
        html {
            scroll-behavior: smooth;
        }
        body {
            -webkit-overflow-scrolling: touch; /* Enables smooth momentum scrolling on iOS */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; /* Native font stack for iOS/Android */
            -webkit-tap-highlight-color: transparent; /* Removes tap highlight on mobile */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        .text-sm { font-size: 0.875rem; }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px; /* Slightly more square for modern mobile look */
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 1rem;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            width: 100%; /* Full width buttons for easier tapping on mobile */
        }
        .btn-primary:active { background-color: var(--primary-hover); transform: scale(0.98); }
        
        .btn-green {
            background-color: var(--spotify-green);
            color: white;
            width: 100%;
        }
        .btn-green:active { background-color: var(--spotify-green-hover); transform: scale(0.98); }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: var(--text-main);
            width: 100%;
        }
        .btn-disabled {
            background-color: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            width: 100%;
        }

        /* Inputs */
        input, select, textarea {
            width: 100%;
            padding: 14px; /* Larger padding for touch targets */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 16px; /* Prevents zoom on iOS input focus */
            background: #fff;
        }
        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none; /* Allows clicks to pass through */
        }
        .toast {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 14px 24px;
            border-radius: 50px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: auto;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* --- LOGIN SCREENS --- */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }
        .auth-title {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: var(--text-main);
            font-weight: 800;
        }

        /* --- USER DASHBOARD --- */
        .user-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-nav h2 { font-size: 1.25rem; font-weight: 800; }
        .logout-btn { font-size: 0.9rem; color: var(--error); text-decoration: none; font-weight: 600; }

        /* Home Slider Type */
        .home-card {
            background: linear-gradient(135deg, var(--primary-color), #6366f1);
            color: white;
            padding: 2.5rem 1.5rem;
            border-radius: 20px;
            margin: 1rem;
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        .balance-display { font-size: 2.5rem; font-weight: 800; margin: 10px 0; letter-spacing: -1px; }
        .user-id-display { font-family: monospace; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; }

        /* Bottom Nav for User */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 20px 0; /* Extra padding for iOS home indicator */
            border-top: 1px solid #e5e7eb;
            z-index: 99;
            padding-bottom: max(8px, env(safe-area-inset-bottom)); /* Safe area for iPhone X+ */
        }
        .nav-item {
            text-align: center;
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.75rem;
            flex: 1;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px 0;
        }
        .nav-item.active { color: var(--primary-color); font-weight: 700; }
        .nav-icon { display: block; font-size: 1.4rem; margin-bottom: 2px; }

        /* Task List - Updated for separate buttons */
        .task-item {
            background: white;
            margin: 1rem;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
            transition: transform 0.2s ease;
        }
        .task-item:active { transform: scale(0.99); }
        .task-img { width: 100%; height: 160px; object-fit: cover; border-radius: 12px; margin-bottom: 12px; }
        
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .task-title { font-size: 1.1rem; font-weight: 700; color: #111; }
        .task-reward { color: #059669; font-weight: 700; background: #ecfdf5; padding: 4px 8px; border-radius: 6px; font-size: 0.9rem; }
        .task-desc { color: #6b7280; font-size: 0.9rem; margin-bottom: 15px; line-height: 1.4; }

        .task-actions { display: flex; gap: 10px; }
        
        /* Withdraw Section */
        .withdraw-info {
            text-align: center;
            padding: 1rem;
            background: #fffbeb;
            color: #b45309;
            margin: 1rem;
            border-radius: 12px;
            border: 1px solid #fcd34d;
        }

        /* --- ADMIN DASHBOARD --- */
        .admin-layout {
            display: flex;
            background-color: var(--spotify-black);
            color: var(--spotify-white);
            min-height: 100vh;
        }
        .admin-sidebar {
            width: 250px;
            background-color: var(--spotify-black);
            padding: 24px;
            display: flex;
            flex-direction: column;
        }
        .admin-logo {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-nav-link {
            color: var(--spotify-text-grey);
            text-decoration: none;
            padding: 12px 0;
            display: block;
            font-weight: 700;
            transition: color 0.3s;
            cursor: pointer;
        }
        .admin-nav-link:hover, .admin-nav-link.active {
            color: var(--spotify-white);
        }
        .admin-content {
            flex: 1;
            background: linear-gradient(180deg, #222 0%, var(--spotify-black) 40%);
            padding: 2rem;
            overflow-y: auto;
        }
        
        .spotify-card {
            background-color: var(--spotify-dark-grey);
            padding: 1.5rem;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .spotify-card:hover {
            background-color: var(--spotify-light-grey);
        }
        .spotify-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 2rem;
        }
        .spotify-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--spotify-text-grey);
        }
        .spotify-table th { text-align: left; border-bottom: 1px solid #333; padding: 12px 10px; color: white; font-size: 0.9rem; }
        .spotify-table td { padding: 12px 10px; border-bottom: 1px solid #282828; font-size: 0.9rem; }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-processing { background: #f59e0b; color: #fff; }
        .status-paying { background: #3b82f6; color: #fff; }
        .status-completed { background: var(--spotify-green); color: #fff; }
        .status-cancelled { background: var(--error); color: #fff; }

        @media (max-width: 768px) {
            .admin-layout { flex-direction: column; }
            .admin-sidebar { width: 100%; flex-direction: row; overflow-x: auto; padding: 15px; align-items: center; white-space: nowrap; }
            .admin-logo { margin-bottom: 0; margin-right: 20px; font-size: 1.2rem; }
            .admin-nav-link { padding: 10px 15px; border-radius: 20px; }
            .admin-nav-link.active { background-color: #282828; }
            .admin-content { padding: 1rem; padding-bottom: 80px; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- ================== AUTHENTICATION VIEWS ================== -->
    <div id="view-auth" class="">
        <div id="login-card" class="auth-container">
            <h2 class="auth-title text-center">Welcome Back</h2>
            <p class="text-center mb-4 text-sm text-grey-500">Enter your mobile number to continue</p>
            <form id="login-form">
                <label class="text-sm font-bold" style="display:block; margin-bottom:5px;">Mobile Number</label>
                <input type="tel" id="login-mobile" placeholder="e.g. 9876543210" required pattern="[0-9]{10}" inputmode="numeric">
                <button type="submit" class="btn btn-primary">Get OTP</button>
            </form>
            <div class="mt-4 text-center">
                <a href="#" onclick="app.showAdminLogin()" class="text-sm" style="color: #6b7280;">Admin Login</a>
            </div>
        </div>

        <div id="otp-card" class="auth-container hidden">
            <h2 class="auth-title text-center">Verify OTP</h2>
            <p class="text-center mb-4 text-sm">Enter the code sent to <span id="otp-mobile-display" style="font-weight:bold;"></span></p>
            <form id="otp-form">
                <label class="text-sm font-bold">One Time Password</label>
                <input type="tel" id="login-otp" placeholder="Try: 1234" required maxlength="4" inputmode="numeric" style="text-align: center; letter-spacing: 5px; font-size: 1.5rem;">
                <button type="submit" class="btn btn-primary">Verify & Continue</button>
            </form>
            <button onclick="app.resetLogin()" class="btn btn-secondary mt-4">Change Number</button>
        </div>

        <div id="admin-login-card" class="auth-container hidden">
            <h2 class="auth-title text-center">Admin Portal</h2>
            <form id="admin-form">
                <label class="text-sm font-bold">Admin ID</label>
                <input type="text" id="admin-id" placeholder="Enter ID" required>
                <label class="text-sm font-bold">Password</label>
                <input type="password" id="admin-pass" placeholder="Enter Password" required>
                <button type="submit" class="btn btn-green">Login as Admin</button>
            </form>
            <button onclick="app.resetLogin()" class="btn btn-secondary mt-4">Back</button>
        </div>
    </div>

    <!-- ================== USER DASHBOARD ================== -->
    <div id="view-user" class="hidden">
        <nav class="user-nav">
            <h2>TaskMaster</h2>
            <div class="flex items-center">
                <span class="user-id-display" id="nav-user-id">ID: 00000</span>
                <a href="#" onclick="app.logout()" class="logout-btn ml-2">Logout</a>
            </div>
        </nav>

        <main style="padding-bottom: 80px;">
            
            <section id="user-home" class="user-section">
                <div class="home-card">
                    <div style="opacity: 0.9; font-size: 0.9rem;">Total Balance</div>
                    <div class="balance-display">‚Çπ<span id="user-balance">0</span></div>
                    <div class="flex items-center justify-between mt-2">
                        <span class="user-id-display">ID: <span id="user-id-display">00000</span></span>
                        <span style="font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px;">Verified</span>
                    </div>
                </div>

                <div class="p-4">
                    <h3 style="margin-bottom: 10px; font-weight: 700;">Notifications</h3>
                    <div id="user-notifications-list" style="background: white; border-radius: 12px; padding: 10px;">
                        <!-- Notifications JS -->
                        <p class="text-sm text-grey-500">No new notifications.</p>
                    </div>
                </div>
            </section>

            <section id="user-withdraw" class="user-section hidden">
                <h2 class="p-4">Withdraw Funds</h2>
                <div class="withdraw-info">
                    Minimum withdrawal: ‚Çπ220<br>
                    Instant Bank Transfer
                </div>
                <div class="auth-container" style="margin: 20px; box-shadow: none; border: 1px solid #ddd; background: white;">
                    <label class="text-sm font-bold">Amount (‚Çπ)</label>
                    <input type="number" id="withdraw-amount" placeholder="Min 220" min="220" inputmode="numeric">
                    <label class="text-sm font-bold">Account Holder</label>
                    <input type="text" id="withdraw-name" placeholder="Full Name">
                    <label class="text-sm font-bold">Account Number</label>
                    <input type="number" id="withdraw-acc" placeholder="Bank Account" inputmode="numeric">
                    <label class="text-sm font-bold">IFSC Code</label>
                    <input type="text" id="withdraw-ifsc" placeholder="e.g. SBIN0001" style="text-transform: uppercase;">
                    
                    <button onclick="app.requestWithdrawal()" class="btn btn-primary">Withdraw Now</button>
                </div>

                <h3 class="p-4 font-bold">Transaction History</h3>
                <div id="user-withdraw-history" class="p-4">
                    <!-- History -->
                </div>
            </section>

            <section id="user-task" class="user-section hidden">
                <h2 class="p-4 font-bold">Daily Tasks</h2>
                <div id="task-list-container">
                    <!-- Tasks JS -->
                </div>
            </section>

            <section id="user-help" class="user-section hidden">
                <div class="text-center p-4 mt-4">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üõ†Ô∏è</div>
                    <h1>Help Center</h1>
                    <p class="mt-4 text-gray-500">Our support team is coming soon...</p>
                </div>
            </section>

        </main>

        <nav class="bottom-nav">
            <a onclick="app.navUser('home')" class="nav-item active" id="tab-home">
                <span class="nav-icon">üè†</span>
                Home
            </a>
            <a onclick="app.navUser('withdraw')" class="nav-item" id="tab-withdraw">
                <span class="nav-icon">üí∏</span>
                Wallet
            </a>
            <a onclick="app.navUser('task')" class="nav-item" id="tab-task">
                <span class="nav-icon">üìã</span>
                Tasks
            </a>
            <a onclick="app.navUser('help')" class="nav-item" id="tab-help">
                <span class="nav-icon">‚ùì</span>
                Help
            </a>
        </nav>
    </div>

    <!-- ================== ADMIN DASHBOARD ================== -->
    <div id="view-admin" class="hidden admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-logo">üéµ Admin</div>
            <a onclick="app.navAdmin('dashboard')" class="admin-nav-link active" id="adm-tab-dashboard">Dashboard</a>
            <a onclick="app.navAdmin('users')" class="admin-nav-link" id="adm-tab-users">Users</a>
            <a onclick="app.navAdmin('tasks')" class="admin-nav-link" id="adm-tab-tasks">Tasks</a>
            <a onclick="app.navAdmin('withdrawals')" class="admin-nav-link" id="adm-tab-withdrawals">Withdrawals</a>
            <div style="flex-grow:1"></div>
            <a onclick="app.logout()" class="admin-nav-link" style="color: var(--error);">Logout</a>
        </aside>

        <main class="admin-content">
            <div id="adm-dashboard">
                <h1 class="mb-4">Overview</h1>
                <div class="spotify-grid">
                    <div class="spotify-card">
                        <h3>Total Users</h3>
                        <p class="font-bold" style="font-size: 2rem;" id="adm-total-users">0</p>
                    </div>
                    <div class="spotify-card">
                        <h3>Pending Withdrawals</h3>
                        <p class="font-bold" style="font-size: 2rem;" id="adm-pending-withdraw">0</p>
                    </div>
                </div>
                
                <h2 class="mb-4">Broadcast Notification</h2>
                <div class="spotify-card">
                    <div class="flex gap-2">
                        <input type="text" id="notif-input" placeholder="Message for all users..." style="margin-bottom:0;">
                        <button onclick="app.sendNotification()" class="btn btn-green">Send</button>
                    </div>
                </div>
            </div>

            <div id="adm-users" class="hidden">
                <h1 class="mb-4">User Management</h1>
                <div class="spotify-card">
                    <table class="spotify-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mobile</th>
                                <th>Balance</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="adm-user-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="adm-tasks" class="hidden">
                <h1 class="mb-4">Task Management</h1>
                <div class="spotify-card mb-4">
                    <h3>Create New Task</h3>
                    <div class="flex flex-col mt-2">
                        <input type="text" id="new-task-title" placeholder="Task Title">
                        <input type="number" id="new-task-reward" placeholder="Reward (Rs)" inputmode="numeric">
                        <textarea id="new-task-desc" placeholder="Description..." rows="2"></textarea>
                        <button onclick="app.createTask()" class="btn btn-green">Publish</button>
                    </div>
                </div>
                <h3 class="mb-4">Submissions</h3>
                <div class="spotify-card">
                    <table class="spotify-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Task</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="adm-submission-table"></tbody>
                    </table>
                </div>
            </div>

            <div id="adm-withdrawals" class="hidden">
                <h1 class="mb-4">Withdrawal Requests</h1>
                <div class="spotify-card">
                    <table class="spotify-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Bank</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adm-withdraw-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- ================== JAVASCRIPT ================== -->
    <script>
        const app = {
            data: {
                currentUser: null,
                isAdmin: false,
                users: [],
                tasks: [],
                withdrawals: [],
                notifications: [],
                submissions: []
            },

            init: function() {
                this.loadData();
                this.checkSession();
            },

            loadData: function() {
                const storedUsers = localStorage.getItem('tm_users');
                if (storedUsers) {
                    this.data.users = JSON.parse(storedUsers);
                    this.data.tasks = JSON.parse(localStorage.getItem('tm_tasks')) || [];
                    this.data.withdrawals = JSON.parse(localStorage.getItem('tm_withdrawals')) || [];
                    this.data.notifications = JSON.parse(localStorage.getItem('tm_notifications')) || [];
                    this.data.submissions = JSON.parse(localStorage.getItem('tm_submissions')) || [];
                } else {
                    // Seed Data
                    this.data.users = [
                        { id: 11234, mobile: '9876543210', balance: 500, acceptedTasks: [] },
                        { id: 55678, mobile: '1234567890', balance: 1250, acceptedTasks: [] }
                    ];
                    this.data.tasks = [
                        { id: 1, title: 'Subscribe YouTube Channel', reward: 50, desc: 'Subscribe to the tech channel and ring the bell.', image: 'https://picsum.photos/seed/yt/300/160' },
                        { id: 2, title: 'Install & Open App', reward: 150, desc: 'Install the shopping app and browse for 2 mins.', image: 'https://picsum.photos/seed/app/300/160' }
                    ];
                    this.data.notifications = [
                        { msg: 'Welcome! Complete tasks to earn.', date: new Date().toLocaleDateString() }
                    ];
                    this.saveData();
                }
            },

            saveData: function() {
                localStorage.setItem('tm_users', JSON.stringify(this.data.users));
                localStorage.setItem('tm_tasks', JSON.stringify(this.data.tasks));
                localStorage.setItem('tm_withdrawals', JSON.stringify(this.data.withdrawals));
                localStorage.setItem('tm_notifications', JSON.stringify(this.data.notifications));
                localStorage.setItem('tm_submissions', JSON.stringify(this.data.submissions));
            },

            // --- AUTH ---
            showAdminLogin: function() {
                document.getElementById('login-card').classList.add('hidden');
                document.getElementById('admin-login-card').classList.remove('hidden');
            },
            resetLogin: function() {
                document.getElementById('login-card').classList.remove('hidden');
                document.getElementById('otp-card').classList.add('hidden');
                document.getElementById('admin-login-card').classList.add('hidden');
            },
            handleLogin: function(e) {
                e.preventDefault();
                const mobile = document.getElementById('login-mobile').value;
                if(mobile.length !== 10) return this.toast('Please enter a valid 10-digit number', 'error');

                let user = this.data.users.find(u => u.mobile === mobile);
                if (!user) {
                    const newId = Math.floor(10000 + Math.random() * 90000);
                    user = { id: newId, mobile: mobile, balance: 0, acceptedTasks: [] };
                    this.data.users.push(user);
                    this.saveData();
                }

                document.getElementById('login-mobile').value = '';
                document.getElementById('login-card').classList.add('hidden');
                document.getElementById('otp-card').classList.remove('hidden');
                document.getElementById('otp-mobile-display').innerText = mobile;
                this.tempMobile = mobile;
                this.toast('OTP Sent! (Try 1234)', 'success');
            },
            handleOtp: function(e) {
                e.preventDefault();
                const otp = document.getElementById('login-otp').value;
                if (otp !== '1234') return this.toast('Incorrect OTP', 'error');

                const user = this.data.users.find(u => u.mobile === this.tempMobile);
                this.data.currentUser = user;
                this.data.isAdmin = false;
                
                this.renderUserDashboard();
                this.switchView('view-user');
                document.getElementById('otp-form').reset();
            },
            handleAdminLogin: function(e) {
                e.preventDefault();
                const id = document.getElementById('admin-id').value;
                const pass = document.getElementById('admin-pass').value;
                if (id === 'admin' && pass === '2004') {
                    this.data.currentUser = { id: 'admin', name: 'Admin' };
                    this.data.isAdmin = true;
                    this.renderAdminDashboard();
                    this.switchView('view-admin');
                } else {
                    this.toast('Invalid credentials', 'error');
                }
            },
            logout: function() {
                this.data.currentUser = null;
                this.data.isAdmin = false;
                this.switchView('view-auth');
                this.resetLogin();
            },
            checkSession: function() { this.switchView('view-auth'); },

            // --- NAV ---
            switchView: function(viewId) {
                ['view-auth', 'view-user', 'view-admin'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(viewId).classList.remove('hidden');
                // Scroll to top when switching views
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            navUser: function(tab) {
                document.querySelectorAll('.user-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`user-${tab}`).classList.remove('hidden');
                document.querySelectorAll('.bottom-nav .nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
            },
            navAdmin: function(tab) {
                document.querySelectorAll('#view-admin main > div').forEach(el => el.classList.add('hidden'));
                document.getElementById(`adm-${tab}`).classList.remove('hidden');
                document.querySelectorAll('.admin-nav-link').forEach(el => el.classList.remove('active'));
                document.getElementById(`adm-tab-${tab}`).classList.add('active');
            },

            // --- USER LOGIC ---
            renderUserDashboard: function() {
                const user = this.data.currentUser;
                document.getElementById('nav-user-id').innerText = `ID: ${user.id}`;
                document.getElementById('user-id-display').innerText = user.id;
                document.getElementById('user-balance').innerText = user.balance;

                // Notifications
                const notifList = document.getElementById('user-notifications-list');
                notifList.innerHTML = '';
                if(this.data.notifications.length === 0) {
                    notifList.innerHTML = '<p class="text-sm text-grey-500 text-center">No new notifications.</p>';
                } else {
                    this.data.notifications.slice().reverse().forEach(n => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-b border-gray-100 text-sm';
                        div.innerHTML = `<div class="font-bold text-xs text-gray-400">${n.date}</div><div>${n.msg}</div>`;
                        notifList.appendChild(div);
                    });
                }

                // Tasks
                const taskContainer = document.getElementById('task-list-container');
                taskContainer.innerHTML = '';
                this.data.tasks.forEach(task => {
                    // Check if user has already submitted this task (checking submissions history)
                    const isSubmitted = this.data.submissions.some(s => s.userId === user.id && s.taskId === task.id && s.status === 'Approved');
                    
                    // Check if user has accepted but not submitted (checking user acceptedTasks array)
                    const isAccepted = user.acceptedTasks && user.acceptedTasks.includes(task.id);

                    let buttonHtml = '';
                    if (isSubmitted) {
                        buttonHtml = `<button class="btn btn-disabled" disabled>Completed</button>`;
                    } else if (isAccepted) {
                        // Show Submit Button
                        buttonHtml = `<button onclick="app.submitTask(${task.id})" class="btn btn-green">Submit Proof</button>`;
                    } else {
                        // Show Accept Button
                        buttonHtml = `<button onclick="app.acceptTask(${task.id})" class="btn btn-primary">Accept Task</button>`;
                    }

                    const el = document.createElement('div');
                    el.className = 'task-item';
                    el.innerHTML = `
                        <img src="${task.image}" class="task-img" alt="Task" loading="lazy">
                        <div class="task-header">
                            <span class="task-title">${task.title}</span>
                            <span class="task-reward">+‚Çπ${task.reward}</span>
                        </div>
                        <p class="task-desc">${task.desc}</p>
                        <div class="task-actions">
                            ${buttonHtml}
                        </div>
                    `;
                    taskContainer.appendChild(el);
                });

                this.renderWithdrawHistory();
            },

            // SEPARATE ACCEPT FUNCTION
            acceptTask: function(taskId) {
                const user = this.data.currentUser;
                if (!user.acceptedTasks) user.acceptedTasks = [];
                
                user.acceptedTasks.push(taskId);
                this.saveData();
                
                // Re-render specifically or whole dashboard. 
                // Re-rendering whole dashboard is simpler for this state logic.
                this.renderUserDashboard();
                this.toast('Task Accepted! Please complete it and submit proof.', 'success');
            },

            // SEPARATE SUBMIT FUNCTION
            submitTask: function(taskId) {
                const task = this.data.tasks.find(t => t.id === taskId);
                
                // Trigger File Input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = e => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        
                        // 1. Create Submission
                        const submission = {
                            id: Date.now(),
                            userId: this.data.currentUser.id,
                            taskId: task.id,
                            taskTitle: task.title,
                            reward: task.reward,
                            status: 'Pending',
                            proof: file.name,
                            date: new Date().toISOString()
                        };
                        this.data.submissions.push(submission);

                        // 2. Remove from Accepted Tasks (since it's now submitted)
                        const idx = this.data.currentUser.acceptedTasks.indexOf(taskId);
                        if (idx > -1) {
                            this.data.currentUser.acceptedTasks.splice(idx, 1);
                        }

                        this.saveData();
                        this.renderUserDashboard(); // UI will now show "Completed" (or wait, let's keep it showing submitted status)
                        // Currently render logic checks 'Approved'. If 'Pending', it might show accept again?
                        // Let's update render logic to treat 'Pending' as 'Submitted' state to avoid re-submitting.
                        // Correction: I will modify the render logic below to handle Pending.
                        
                        this.toast('Proof submitted! Waiting for admin review.', 'success');
                    }
                };
                input.click();
            },

            // Override render slightly to show "Under Review" if Pending
            renderUserDashboard: function() { 
                // ... (Previous code copy) ...
                const user = this.data.currentUser;
                document.getElementById('nav-user-id').innerText = `ID: ${user.id}`;
                document.getElementById('user-id-display').innerText = user.id;
                document.getElementById('user-balance').innerText = user.balance;

                const notifList = document.getElementById('user-notifications-list');
                notifList.innerHTML = '';
                if(this.data.notifications.length === 0) {
                    notifList.innerHTML = '<p class="text-sm text-grey-500 text-center">No new notifications.</p>';
                } else {
                    this.data.notifications.slice().reverse().forEach(n => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-b border-gray-100 text-sm';
                        div.innerHTML = `<div class="font-bold text-xs text-gray-400">${n.date}</div><div>${n.msg}</div>`;
                        notifList.appendChild(div);
                    });
                }

                const taskContainer = document.getElementById('task-list-container');
                taskContainer.innerHTML = '';
                this.data.tasks.forEach(task => {
                    // Check status
                    const submission = this.data.submissions.find(s => s.userId === user.id && s.taskId === task.id);
                    const isSubmitted = submission && (submission.status === 'Pending' || submission.status === 'Approved');
                    const isAccepted = user.acceptedTasks && user.acceptedTasks.includes(task.id);

                    let buttonHtml = '';
                    if (isSubmitted) {
                        if(submission.status === 'Approved') {
                             buttonHtml = `<button class="btn btn-disabled" disabled>Completed</button>`;
                        } else {
                             buttonHtml = `<button class="btn btn-disabled" disabled>Under Review</button>`;
                        }
                    } else if (isAccepted) {
                        buttonHtml = `<button onclick="app.submitTask(${task.id})" class="btn btn-green">Submit Proof</button>`;
                    } else {
                        buttonHtml = `<button onclick="app.acceptTask(${task.id})" class="btn btn-primary">Accept Task</button>`;
                    }

                    const el = document.createElement('div');
                    el.className = 'task-item';
                    el.innerHTML = `
                        <img src="${task.image}" class="task-img" alt="Task" loading="lazy">
                        <div class="task-header">
                            <span class="task-title">${task.title}</span>
                            <span class="task-reward">+‚Çπ${task.reward}</span>
                        </div>
                        <p class="task-desc">${task.desc}</p>
                        <div class="task-actions">
                            ${buttonHtml}
                        </div>
                    `;
                    taskContainer.appendChild(el);
                });

                this.renderWithdrawHistory();
            },

            renderWithdrawHistory: function() {
                const histContainer = document.getElementById('user-withdraw-history');
                histContainer.innerHTML = '';
                const userWithdrawals = this.data.withdrawals.filter(w => w.userId === this.data.currentUser.id);
                
                if(userWithdrawals.length === 0) {
                    histContainer.innerHTML = '<p class="text-center text-sm text-gray-400 py-4">No transactions yet.</p>';
                    return;
                }

                userWithdrawals.slice().reverse().forEach(w => {
                    let badgeClass = '';
                    if(w.status === 'Processing') badgeClass = 'status-processing';
                    else if(w.status === 'Paying') badgeClass = 'status-paying';
                    else if(w.status === 'Completed') badgeClass = 'status-completed';
                    else if(w.status === 'Cancelled') badgeClass = 'status-cancelled';

                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 border-b border-gray-100 bg-white rounded-lg mb-2';
                    div.innerHTML = `
                        <div>
                            <div class="font-bold">‚Çπ${w.amount}</div>
                            <div class="text-xs text-gray-500">${new Date(w.date).toLocaleString()}</div>
                        </div>
                        <span class="status-badge ${badgeClass}">${w.status}</span>
                    `;
                    histContainer.appendChild(div);
                });
            },

            requestWithdrawal: function() {
                const amount = parseInt(document.getElementById('withdraw-amount').value);
                const name = document.getElementById('withdraw-name').value;
                const acc = document.getElementById('withdraw-acc').value;
                const ifsc = document.getElementById('withdraw-ifsc').value;

                if (amount < 220) return this.toast('Minimum withdrawal is ‚Çπ220', 'error');
                if (amount > this.data.currentUser.balance) return this.toast('Insufficient balance', 'error');
                if (!name || !acc || !ifsc) return this.toast('Please fill all details', 'error');

                this.data.currentUser.balance -= amount;
                const req = {
                    id: Date.now(),
                    userId: this.data.currentUser.id,
                    amount: amount,
                    bank: { name, acc, ifsc },
                    status: 'Processing',
                    date: new Date().toISOString()
                };
                this.data.withdrawals.push(req);
                this.saveData();
                this.renderUserDashboard();
                document.getElementById('withdraw-amount').value = '';
                this.toast('Withdrawal submitted successfully', 'success');

                setTimeout(() => {
                    req.status = 'Paying';
                    this.saveData();
                    if(this.data.currentUser && this.data.currentUser.id === req.userId) {
                        this.renderWithdrawHistory();
                    }
                    this.toast(`Withdrawal of ‚Çπ${amount} is now paying`, 'success');
                }, 15000);
            },

            // --- ADMIN LOGIC ---
            renderAdminDashboard: function() {
                document.getElementById('adm-total-users').innerText = this.data.users.length;
                document.getElementById('adm-pending-withdraw').innerText = this.data.withdrawals.filter(w => w.status === 'Paying' || w.status === 'Processing').length;

                const userBody = document.getElementById('adm-user-table-body');
                userBody.innerHTML = '';
                this.data.users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.id}</td>
                        <td>${u.mobile}</td>
                        <td contenteditable="true" onblur="app.updateUserBalance(${u.id}, this.innerText)">${u.balance}</td>
                        <td><button onclick="app.addBalance(${u.id})" class="btn btn-green text-sm" style="padding:4px 8px;">Add</button></td>
                    `;
                    userBody.appendChild(tr);
                });

                const withdrawBody = document.getElementById('adm-withdraw-table-body');
                withdrawBody.innerHTML = '';
                this.data.withdrawals.forEach(w => {
                    let actions = '';
                    if(w.status === 'Paying' || w.status === 'Processing') {
                        actions = `<button onclick="app.setWithdrawStatus(${w.id}, 'Completed')" class="btn btn-green text-sm" style="padding:4px 8px;">‚úì</button> <button onclick="app.setWithdrawStatus(${w.id}, 'Cancelled')" class="btn btn-danger text-sm" style="padding:4px 8px;">‚úó</button>`;
                    } else {
                        actions = w.status;
                    }
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${w.userId}</td>
                        <td>‚Çπ${w.amount}</td>
                        <td class="text-sm">${w.bank.name}<br>${w.bank.acc}</td>
                        <td><span class="status-badge status-${w.status.toLowerCase()}">${w.status}</span></td>
                        <td>${actions}</td>
                    `;
                    withdrawBody.appendChild(tr);
                });

                const subBody = document.getElementById('adm-submission-table');
                subBody.innerHTML = '';
                this.data.submissions.forEach(s => {
                    let actionHtml = '';
                    if(s.status === 'Pending') {
                        actionHtml = `<button onclick="app.approveSubmission(${s.id})" class="btn btn-green text-sm" style="padding:4px 8px;">Approve</button> <button onclick="app.rejectSubmission(${s.id})" class="btn btn-danger text-sm" style="padding:4px 8px;">Reject</button>`;
                    } else {
                        actionHtml = s.status;
                    }
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${s.userId}</td>
                        <td>${s.taskTitle} (‚Çπ${s.reward})</td>
                        <td>${s.status}</td>
                        <td>${s.proof}</td>
                        <td>${actionHtml}</td>
                    `;
                    subBody.appendChild(tr);
                });
            },

            updateUserBalance: function(userId, newBal) {
                const user = this.data.users.find(u => u.id === userId);
                if(user) {
                    user.balance = parseInt(newBal);
                    this.saveData();
                    this.toast('Updated balance', 'success');
                }
            },
            addBalance: function(userId) {
                const amount = prompt("Enter amount to add:");
                if(amount && !isNaN(amount)) {
                    const user = this.data.users.find(u => u.id === userId);
                    if(user) {
                        user.balance += parseInt(amount);
                        this.saveData();
                        this.renderAdminDashboard();
                        this.toast(`Added ‚Çπ${amount} to user ${userId}`, 'success');
                    }
                }
            },
            setWithdrawStatus: function(withdrawId, status) {
                const w = this.data.withdrawals.find(x => x.id === withdrawId);
                if(w) {
                    w.status = status;
                    if(status === 'Cancelled') {
                        const user = this.data.users.find(u => u.id === w.userId);
                        if(user) user.balance += w.amount;
                    }
                    this.saveData();
                    this.renderAdminDashboard();
                    this.toast(`Withdrawal ${status}`, 'success');
                }
            },
            createTask: function() {
                const title = document.getElementById('new-task-title').value;
                const reward = document.getElementById('new-task-reward').value;
                const desc = document.getElementById('new-task-desc').value;
                if(!title || !reward) return this.toast('Title and Reward required', 'error');
                const newTask = {
                    id: Date.now(),
                    title, reward, desc,
                    image: `https://picsum.photos/seed/${Date.now()}/300/160`
                };
                this.data.tasks.push(newTask);
                this.saveData();
                this.renderAdminDashboard();
                document.getElementById('new-task-title').value = '';
                document.getElementById('new-task-reward').value = '';
                document.getElementById('new-task-desc').value = '';
                this.toast('Task created', 'success');
            },
            approveSubmission: function(subId) {
                const sub = this.data.submissions.find(s => s.id === subId);
                if(sub) {
                    sub.status = 'Approved';
                    const user = this.data.users.find(u => u.id === sub.userId);
                    if(user) user.balance += parseInt(sub.reward);
                    this.saveData();
                    this.renderAdminDashboard();
                    this.toast('Approved & Balance Added', 'success');
                }
            },
            rejectSubmission: function(subId) {
                const sub = this.data.submissions.find(s => s.id === subId);
                if(sub) {
                    sub.status = 'Rejected';
                    this.saveData();
                    this.renderAdminDashboard();
                    this.toast('Submission Rejected', 'error');
                }
            },
            sendNotification: function() {
                const input = document.getElementById('notif-input');
                const msg = input.value;
                if(!msg) return;
                this.data.notifications.push({ msg, date: new Date().toLocaleDateString() });
                this.saveData();
                input.value = '';
                this.toast('Notification sent', 'success');
            },
            toast: function(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.style.borderLeft = `4px solid ${type === 'success' ? '#1db954' : '#e91429'}`;
                toast.innerText = message;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };

        document.getElementById('login-form').addEventListener('submit', (e) => app.handleLogin(e));
        document.getElementById('otp-form').addEventListener('submit', (e) => app.handleOtp(e));
        document.getElementById('admin-form').addEventListener('submit', (e) => app.handleAdminLogin(e));
        app.init();
    </script>
</body>
</html>
